name: Ubuntu-RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Disable snapd
        run: |
          sudo systemctl stop snapd.service snapd.socket || true
          sudo apt-get purge -y snapd || true
          sudo rm -rf /snap /var/snap /var/lib/snapd || true

      - name: Install minimal XFCE + XRDP
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4-session xfwm4 xfdesktop4 xfce4-panel xfce4-terminal \
            xorg xrdp

          echo "startxfce4" | sudo tee /etc/skel/.xsession
          sudo systemctl enable xrdp --now

      - name: Create RDP user
        run: |
          USER=rdp
          PASS=$(openssl rand -base64 16)
          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASS" | sudo chpasswd
          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale
        env:
          KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$KEY --hostname="ubuntu-rdp-${GITHUB_RUN_ID}"
          echo "TS_IP=$(tailscale ip -4 | head -n 1)" >> $GITHUB_ENV

      - name: Connection Details
        run: |
          echo "===== RDP INFO ====="
          echo "IP: $TS_IP"
          echo "User: $RDP_USER"
          echo "Pass: $RDP_PASS"
          echo "===================="

      - name: Keep Alive
        run: |
          while true; do
            echo "Alive at $(date)"
            sleep 120
          done
