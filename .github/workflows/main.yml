name: Windows-AnyDesk-MSI

on:
  workflow_dispatch:

jobs:
  anydesk-session:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Generate AnyDesk Password
        run: |
          $pwd = -join (((48..57) + (65..90) + (97..122)) | Get-Random -Count 12 | % {[char]$_})
          echo "ANYDESK_PASSWORD=$pwd" >> $env:GITHUB_ENV

      - name: Download AnyDesk MSI
        run: |
          Invoke-WebRequest "https://download.anydesk.com/AnyDesk.msi" -OutFile "AnyDesk.msi"

      - name: Install AnyDesk (FAST MSI Install)
        run: |
          Write-Host "Installing AnyDesk via MSI..."
          msiexec /i AnyDesk.msi /qn /norestart
          Write-Host "AnyDesk Installed."

      - name: Start AnyDesk Service
        run: |
          Start-Service AnyDesk
          Set-Service AnyDesk -StartupType Automatic

      - name: Set AnyDesk Password
        run: |
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-password "$env:ANYDESK_PASSWORD"

      - name: Enable Full Permissions
        run: |
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission file_transfer:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission clipboard:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission audio:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission input_control:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission remote_restart:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission privacy_mode:false

      - name: Get AnyDesk ID
        run: |
          $id = & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --get-id
          echo "ANYDESK_ID=$id" >> $env:GITHUB_ENV

      - name: Show Connection Info
        run: |
          Write-Host "=========================================="
          Write-Host " WINDOWS ANYDESK READY"
          Write-Host "=========================================="
          Write-Host "AnyDesk ID       : $env:ANYDESK_ID"
          Write-Host "AnyDesk Password : $env:ANYDESK_PASSWORD"
          Write-Host ""
          Write-Host "You can now connect using AnyDesk."
          Write-Host "=========================================="

      - name: Keep Alive
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
