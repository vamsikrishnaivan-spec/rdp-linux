name: Windows-AnyDesk

on:
  workflow_dispatch:

jobs:
  anydesk-session:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Set AnyDesk Password
        id: pwd
        run: |
          $pwd = -join (((48..57) + (65..90) + (97..122)) | Get-Random -Count 12 | % {[char]$_})
          echo "ANYDESK_PASSWORD=$pwd" >> $env:GITHUB_ENV

      - name: Download AnyDesk
        run: |
          Invoke-WebRequest "https://download.anydesk.com/AnyDesk.exe" -OutFile "AnyDesk.exe"

      - name: Install AnyDesk (Silent)
        run: |
          Start-Process ".\AnyDesk.exe" -ArgumentList "/install /silent" -Wait

      - name: Start AnyDesk Service
        run: |
          Start-Service AnyDesk
          Set-Service AnyDesk -StartupType Automatic

      - name: Apply AnyDesk Password
        run: |
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-password "$env:ANYDESK_PASSWORD"

      - name: Allow Full Permissions
        run: |
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission clipboard:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission file_transfer:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission audio:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission input_control:true
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission privacy_mode:false
          & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-permission remote_restart:true

      - name: Get AnyDesk Address
        run: |
          $id = & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --get-id
          echo "ANYDESK_ID=$id" >> $env:GITHUB_ENV

      - name: Display Connection Info
        run: |
          Write-Host "========================================="
          Write-Host " WINDOWS ANYDESK REMOTE DESKTOP READY"
          Write-Host "========================================="
          Write-Host "AnyDesk ID       : $env:ANYDESK_ID"
          Write-Host "AnyDesk Password : $env:ANYDESK_PASSWORD"
          Write-Host ""
          Write-Host "You can now connect using AnyDesk."
          Write-Host "========================================="

      - name: Keep Runner Alive
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
