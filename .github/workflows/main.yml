name: Linux-VNC

on:
  workflow_dispatch:

jobs:
  vnc-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install XFCE + VNC
        run: |
          sudo apt update -y
          sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server tigervnc-common dbus-x11

      - name: Create VNC user and password
        run: |
          pw=$(tr -dc 'A-Za-z0-9!@#$%^&*' < /dev/urandom | head -c 12)

          sudo useradd -m -s /bin/bash vncuser || true
          echo "vncuser:$pw" | sudo chpasswd
          sudo usermod -aG sudo vncuser

          echo "VNC_PASS=$pw" >> $GITHUB_ENV
          echo "VNC_USER=vncuser" >> $GITHUB_ENV

          sudo -u vncuser mkdir -p /home/vncuser/.vnc
          printf "%s" "$pw" | vncpasswd -f | sudo tee /home/vncuser/.vnc/passwd >/dev/null
          sudo chmod 600 /home/vncuser/.vnc/passwd
          sudo chown vncuser:vncuser /home/vncuser/.vnc/passwd

          echo "#!/bin/bash" | sudo tee /home/vncuser/.vnc/xstartup > /dev/null
          echo "xrdb \$HOME/.Xresources" | sudo tee -a /home/vncuser/.vnc/xstartup > /dev/null
          echo "startxfce4 &" | sudo tee -a /home/vncuser/.vnc/xstartup > /dev/null
          sudo chmod +x /home/vncuser/.vnc/xstartup
          sudo chown vncuser:vncuser /home/vncuser/.vnc/xstartup

      - name: Start VNC Server
        run: |
          sudo -u vncuser vncserver :1 -geometry 1280x720 -depth 24

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey="$AUTH" --hostname="vnc-linux-${{ github.run_id }}"
          ip=$(tailscale ip -4)
          echo "TAILSCALE_IP=$ip" >> $GITHUB_ENV

      - name: Show VNC Connection Info
        run: |
          echo "==================== VNC ACCESS ===================="
          echo "IP Address : $TAILSCALE_IP:5901"
          echo "User       : $VNC_USER"
          echo "Password   : $VNC_PASS"
          echo "===================================================="

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] VNC Running..."
            sleep 300
          done
