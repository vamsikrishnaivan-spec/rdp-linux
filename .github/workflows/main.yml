name: Ubuntu-AnyDesk

on:
  workflow_dispatch:

jobs:
  anydesk-session:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Create Desktop User + Password
        run: |
          sudo useradd -m desktop || true
          pw=$(openssl rand -base64 10)
          echo "desktop:$pw" | sudo chpasswd
          echo "DESKTOP_PASSWORD=$pw" >> $GITHUB_ENV

      - name: Install XFCE + Xorg
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies xorg dbus-x11

      - name: Start Xorg Display
        run: |
          sudo mkdir -p /tmp/.X11-unix
          sudo chmod 1777 /tmp/.X11-unix

          echo "Starting Xorg on :0"
          sudo Xorg :0 -noreset +extension GLX +extension RANDR +extension RENDER vt1 &
          sleep 5

          export DISPLAY=:0
          sudo -u desktop dbus-launch --exit-with-session xfce4-session &
          sleep 8

      - name: Install AnyDesk
        run: |
          wget https://download.anydesk.com/linux/anydesk_6.3.0-1_amd64.deb
          sudo dpkg -i anydesk_6.3.0-1_amd64.deb || sudo apt --fix-broken install -y

          sudo systemctl enable anydesk
          sudo systemctl start anydesk

          ANYDESK_ADDR=$(anydesk --get-id)
          echo "ANYDESK_ADDR=$ANYDESK_ADDR" >> $GITHUB_ENV

      - name: Set AnyDesk Password + Permissions
        run: |
          echo "$DESKTOP_PASSWORD" | sudo anydesk --set-password
          sudo anydesk --set-permission file_transfer:true
          sudo anydesk --set-permission audio:true
          sudo anydesk --set-permission clipboard:true
          sudo anydesk --set-permission input_control:true

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=linux-anydesk-${{ github.run_id }}

          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      - name: Show Connection Info
        run: |
          echo "======================================="
          echo " UBUNTU + ANYDESK + XFCE READY"
          echo "======================================="
          echo "Tailscale IP: $TS_IP"
          echo "Desktop User: desktop"
          echo "Password: $DESKTOP_PASSWORD"
          echo ""
          echo "AnyDesk Address: $ANYDESK_ADDR"
          echo "AnyDesk Password: $DESKTOP_PASSWORD"
          echo "======================================="

      - name: Keep Alive
        run: while true; do sleep 300; done
