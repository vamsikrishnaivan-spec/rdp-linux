name: Ubuntu-RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Disable snapd (fix Firefox freeze)
        run: |
          sudo systemctl stop snapd.socket snapd.service snapd.seeded.service || true
          sudo systemctl disable snapd.socket snapd.service snapd.seeded.service || true
          sudo apt-get purge -y snapd || true
          sudo rm -rf ~/snap /snap /var/snap /var/lib/snapd

      - name: Update packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common

      - name: Install Xfce + XRDP (minimal desktop, fast)
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-session xfce4-goodies xorg dbus-x11 xrdp

          sudo sed -i 's|console|anybody|g' /etc/X11/Xwrapper.config || true
          sudo sed -i 's|startlxqt|startxfce4|g' /etc/xrdp/startwm.sh || true
          echo "startxfce4" | sudo tee /etc/skel/.xsession

          sudo systemctl enable xrdp --now

      - name: Create RDP user
        run: |
          USER=rdp
          PASSWORD=$(openssl rand -base64 20)

          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USER

          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale
        env:
          AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$AUTH --hostname="ubuntu-rdp-${GITHUB_RUN_ID}"

          TSIP=$(tailscale ip -4 | head -n 1)
          echo "TS_IP=$TSIP" >> $GITHUB_ENV

      - name: Verify RDP port
        run: |
          sudo ss -ltn | grep ":3389" || (echo "XRDP not running!" && exit 1)

      - name: Show connection details
        run: |
          echo "======== RDP ACCESS ========"
          echo "Tailscale IP: $TS_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "Port: 3389"
          echo "============================"

      - name: Keep VM alive
        run: |
          echo "RDP session running. Do NOT close this job."
          while true; do
            echo "Alive at: $(date)"
            sleep 120
          done
